<!DOCTYPE html> <html lang="en"> <head> <meta charset="utf-8"> <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"> <meta http-equiv="X-UA-Compatible" content="IE=edge"> <title>DuckDB - Bringing Big Data To Your Laptop | Sean T. Howard</title> <meta name="author" content="Sean T. Howard"/> <meta name="description" content="Exploring DuckDB's capability on a larger than memory parquet dataset"/> <meta name="keywords" content="jekyll, jekyll-theme, academic-website, portfolio-website"/> <link href="https://cdn.jsdelivr.net/npm/bootstrap@4.6.1/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha256-DF7Zhf293AJxJNTmh5zhoYYIMs2oXitRfBjY+9L//AY=" crossorigin="anonymous"> <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/mdbootstrap@4.20.0/css/mdb.min.css" integrity="sha256-jpjYvU3G3N6nrrBwXJoVEYI/0zw8htfFnhT9ljN3JJw=" crossorigin="anonymous"/> <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@5.15.4/css/all.min.css" integrity="sha256-mUZM63G8m73Mcidfrv5E+Y61y7a12O5mW4ezU3bxqW4=" crossorigin="anonymous"> <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/academicons@1.9.1/css/academicons.min.css" integrity="sha256-i1+4qU2G2860dGGIOJscdC30s9beBXjFfzjWLjBRsBg=" crossorigin="anonymous"> <link rel="stylesheet" type="text/css" href="https://fonts.googleapis.com/css?family=Roboto:300,400,500,700|Roboto+Slab:100,300,400,500,700|Material+Icons"> <link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/jwarby/jekyll-pygments-themes@master/github.css" media="none" id="highlight_theme_light"/> <link rel="shortcut icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>üåå</text></svg>"> <link rel="stylesheet" href="/assets/css/main.css"> <link rel="canonical" href="https://seanhoward.me/blog/2023/DuckDB/"> <link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/jwarby/jekyll-pygments-themes@master/native.css" media="none" id="highlight_theme_dark"/> <script src="/assets/js/theme.js"></script> <script src="/assets/js/dark_mode.js"></script> </head> <body class="fixed-top-nav "> <header> <nav id="navbar" class="navbar navbar-light navbar-expand-sm fixed-top"> <div class="container"> <a class="navbar-brand title font-weight-lighter" href="https://seanhoward.me/"><span class="font-weight-bold">Sean</span> T. Howard</a> <button class="navbar-toggler collapsed ml-auto" type="button" data-toggle="collapse" data-target="#navbarNav" aria-controls="navbarNav" aria-expanded="false" aria-label="Toggle navigation"> <span class="sr-only">Toggle navigation</span> <span class="icon-bar top-bar"></span> <span class="icon-bar middle-bar"></span> <span class="icon-bar bottom-bar"></span> </button> <div class="collapse navbar-collapse text-right" id="navbarNav"> <ul class="navbar-nav ml-auto flex-nowrap"> <li class="nav-item "> <a class="nav-link" href="/">about</a> </li> <li class="nav-item active"> <a class="nav-link" href="/blog/">blog<span class="sr-only">(current)</span></a> </li> <li class="nav-item "> <a class="nav-link" href="/publications/">publications</a> </li> <li class="nav-item "> <a class="nav-link" href="/projects/">projects</a> </li> <li class="toggle-container"> <button id="light-toggle" title="Change theme"> <i class="fas fa-moon"></i> <i class="fas fa-sun"></i> </button> </li> </ul> </div> </div> </nav> </header> <div class="container mt-5"> <div class="post"> <header class="post-header"> <h1 class="post-title">DuckDB - Bringing Big Data To Your Laptop</h1> <p class="post-meta">October 8, 2023</p> <p class="post-tags"> <a href="/blog/2023"> <i class="fas fa-calendar fa-sm"></i> 2023 </a> ¬† ¬∑ ¬† <a href="/blog/tag/Data-Science"> <i class="fas fa-hashtag fa-sm"></i> Data-Science</a> ¬† ¬† ¬∑ ¬† <a href="/blog/category/Intros"> <i class="fas fa-tag fa-sm"></i> Intros</a> ¬† </p> </header> <article class="post-content"> <h3 id="table-of-contents">Table of Contents</h3> <ol> <li><a href="#exploring-duckdb---tons-of-taxis">Exploring DuckDB</a></li> <li><a href="#getting-the-data">The Data</a></li> <li><a href="#duckdb-queries">DuckDB Queries</a></li> <li><a href="#final-thoughts">Final Thoughts</a></li> <li><a href="#duckdb-performance">DuckDB Performance</a></li> </ol> <p><strong>TL;DR</strong>: <a href="https://duckdb.org/" target="_blank" rel="noopener noreferrer">DuckDB</a> is <a href="https://aws.amazon.com/what-is/olap/" target="_blank" rel="noopener noreferrer">online analytical processing (OLAP)</a> database management system with a <a href="https://duckdb.org/docs/archive/0.9.0/api/python/overview" target="_blank" rel="noopener noreferrer">python library</a> providing the ability to quickly perform initial <strong>E</strong>xtract <strong>T</strong>ransform <strong>L</strong>oad (<a href="https://en.wikipedia.org/wiki/Extract,_transform,_load" target="_blank" rel="noopener noreferrer"><strong>ETL</strong></a>) steps on larger than memory datasets without having to resort to heavier solutions like Hadoop/Spark. It‚Äôs a useful tool to extend analysis typically performed in pandas to larger collections of data, especially in parquet format.</p> <h2 id="exploring-duckdb---tons-of-taxis">Exploring DuckDB - Tons of Taxis</h2> <p>This post documents an exploratory analysis of the DuckDB python library to process big data (roughly defined as data which is too large to fit into memory). The candidate <a href="https://www.nyc.gov/site/tlc/about/tlc-trip-record-data.page" target="_blank" rel="noopener noreferrer">dataset</a> used is the great info on taxi trips provided by the New York City Taxi and Limousine Commission. The data is in <a href="https://parquet.apache.org/" target="_blank" rel="noopener noreferrer">parquet</a> format, which is an open source column based format <a href="https://www.databricks.com/glossary/what-is-parquet" target="_blank" rel="noopener noreferrer">‚Äúdesigned for efficent data storage and retrieval‚Äù</a>.</p> <p>In this exploration, I look at the evolution of fare and payment type for NYC yellow taxis from 2009 to present day using DuckDB. While the results are not too surprising (fares are more expensive, more people use credit cards than cash now, and total number of yellow taxis rides is on the decline), I came away very impressed with the performance of DuckDB queries and the usefulness of its python package.</p> <details> <summary> Import DuckDB and other python libraries </summary> <div class="language-python highlighter-rouge"> <div class="highlight"><pre class="highlight"><code><span class="kn">import</span> <span class="n">duckdb</span>
<span class="kn">import</span> <span class="n">matplotlib.pyplot</span> <span class="k">as</span> <span class="n">plt</span>
<span class="kn">from</span> <span class="n">matplotlib.ticker</span> <span class="kn">import</span> <span class="n">PercentFormatter</span>
<span class="kn">import</span> <span class="n">matplotlib.pylab</span> <span class="k">as</span> <span class="n">pl</span>
<span class="kn">import</span> <span class="n">pandas</span> <span class="k">as</span> <span class="n">pd</span>
<span class="kn">import</span> <span class="n">time</span>
<span class="kn">import</span> <span class="n">urllib</span>
<span class="kn">import</span> <span class="n">os.path</span>
<span class="kn">import</span> <span class="n">numpy</span> <span class="k">as</span> <span class="n">np</span>
</code></pre></div> </div> </details> <p><br></p> <h2 id="getting-the-data">Getting the Data</h2> <p>Data from <a href="https://www.nyc.gov/site/tlc/about/tlc-trip-record-data.page" target="_blank" rel="noopener noreferrer">https://www.nyc.gov/site/tlc/about/tlc-trip-record-data.page</a> is provided on a monthly basis all the way back to 2009. Investigating the url‚Äôs from the website, we can see that they follow the format <code class="language-plaintext highlighter-rouge">https://d37ci6vzurychx.cloudfront.net/trip-data/yellow_tripdata_&lt;YYYY&gt;-&lt;MM&gt;.parquet</code>, where <code class="language-plaintext highlighter-rouge">&lt;YYYY&gt;</code> is the year (e.g. <code class="language-plaintext highlighter-rouge">2021</code>) and <code class="language-plaintext highlighter-rouge">&lt;MM&gt;</code> is the month (e.g. <code class="language-plaintext highlighter-rouge">02</code> for February). So first let‚Äôs make a pandas dataframe which stores the appropriate link, month, and year.</p> <h4 id="create-dataframe-relate-links-to-monthsyears">Create dataframe relate links to months/years</h4> <div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># Utilize the % operator for sprintf like formatting
</span><span class="n">BASE_URL</span> <span class="o">=</span> <span class="sh">"</span><span class="s">https://d37ci6vzurychx.cloudfront.net/trip-data/yellow_tripdata_%d-%02d.parquet</span><span class="sh">"</span>
<span class="n">taxi_years</span> <span class="o">=</span> <span class="nf">list</span><span class="p">(</span><span class="nf">range</span><span class="p">(</span><span class="mi">2009</span><span class="p">,</span><span class="mi">2024</span><span class="p">,</span><span class="mi">1</span><span class="p">))</span>
<span class="n">months_as_nums</span> <span class="o">=</span>  <span class="nf">list</span><span class="p">(</span><span class="nf">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">13</span><span class="p">,</span><span class="mi">1</span><span class="p">))</span>

<span class="n">taxi_links</span> <span class="o">=</span> <span class="p">[]</span>
<span class="k">for</span> <span class="n">year</span> <span class="ow">in</span> <span class="n">taxi_years</span><span class="p">:</span>
    <span class="k">for</span> <span class="n">month</span> <span class="ow">in</span> <span class="n">months_as_nums</span><span class="p">:</span>
        <span class="n">taxi_links</span><span class="p">.</span><span class="nf">append</span><span class="p">(</span>
            <span class="p">{</span>
                <span class="sh">'</span><span class="s">year</span><span class="sh">'</span><span class="p">:</span><span class="n">year</span><span class="p">,</span>
                <span class="sh">'</span><span class="s">month</span><span class="sh">'</span><span class="p">:</span><span class="n">month</span><span class="p">,</span>
                <span class="sh">'</span><span class="s">data_url</span><span class="sh">'</span><span class="p">:</span><span class="n">BASE_URL</span> <span class="o">%</span> <span class="p">(</span><span class="n">year</span><span class="p">,</span><span class="n">month</span><span class="p">)</span>
            <span class="p">}</span>
        <span class="p">)</span>

<span class="n">taxi_df</span> <span class="o">=</span> <span class="n">pd</span><span class="p">.</span><span class="n">DataFrame</span><span class="p">.</span><span class="nf">from_records</span><span class="p">(</span><span class="n">taxi_links</span><span class="p">)</span>

<span class="c1">#Remove months that aren't available online/haven't happened yet
</span><span class="n">taxi_df</span> <span class="o">=</span> <span class="n">taxi_df</span><span class="p">[</span><span class="o">~</span><span class="p">((</span><span class="n">taxi_df</span><span class="p">[</span><span class="sh">'</span><span class="s">year</span><span class="sh">'</span><span class="p">]</span><span class="o">==</span><span class="mi">2023</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">taxi_df</span><span class="p">[</span><span class="sh">'</span><span class="s">month</span><span class="sh">'</span><span class="p">]</span><span class="o">&gt;</span><span class="mi">7</span><span class="p">))]</span> 
</code></pre></div></div> <div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">taxi_df</span><span class="p">.</span><span class="nf">head</span><span class="p">()</span>
</code></pre></div></div> <div> <style scoped="">.dataframe tbody tr th:only-of-type{vertical-align:middle}.dataframe tbody tr th{vertical-align:top}.dataframe thead th{text-align:right}</style> <table border="1" class="dataframe"> <thead> <tr style="text-align: right;"> <th></th> <th>year</th> <th>month</th> <th>data_url</th> </tr> </thead> <tbody> <tr> <th>0</th> <td>2009</td> <td>1</td> <td>https://d37ci6vzurychx.cloudfront.net/trip-data/yellow_tripdata_2009-01.parquet</td> </tr> <tr> <th>1</th> <td>2009</td> <td>2</td> <td>https://d37ci6vzurychx.cloudfront.net/trip-data/yellow_tripdata_2009-02.parquet</td> </tr> <tr> <th>2</th> <td>2009</td> <td>3</td> <td>https://d37ci6vzurychx.cloudfront.net/trip-data/yellow_tripdata_2009-03.parquet</td> </tr> <tr> <th>3</th> <td>2009</td> <td>4</td> <td>https://d37ci6vzurychx.cloudfront.net/trip-data/yellow_tripdata_2009-04.parquet</td> </tr> <tr> <th>4</th> <td>2009</td> <td>5</td> <td>https://d37ci6vzurychx.cloudfront.net/trip-data/yellow_tripdata_2009-05.parquet</td> </tr> </tbody> </table> </div> <p><br></p> <h4 id="downloading-the-data">Downloading the Data</h4> <details> <summary> Here's the code to download the data to the local folder. Local paths are added to taxi_df dataframe in the filename column. </summary> <p><br> Next step is to download the data using the <code class="language-plaintext highlighter-rouge">urllib</code> package. Th below code downloads the data to the current folder with the same naming convention as provided by the NYC Taxi &amp; Limousine Commision.</p> <div class="language-python highlighter-rouge"> <div class="highlight"><pre class="highlight"><code><span class="k">for</span> <span class="n">url</span> <span class="ow">in</span> <span class="n">taxi_df</span><span class="p">.</span><span class="n">data_url</span><span class="p">:</span>
    <span class="c1">#check to see if file is downloaded in-case rerunning script
</span>    <span class="k">if</span> <span class="ow">not</span><span class="p">(</span><span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="nf">isfile</span><span class="p">(</span><span class="n">url</span><span class="p">.</span><span class="nf">split</span><span class="p">(</span><span class="sh">'</span><span class="s">/</span><span class="sh">'</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">])):</span>
        <span class="n">urllib</span><span class="p">.</span><span class="n">request</span><span class="p">.</span><span class="nf">urlretrieve</span><span class="p">(</span><span class="n">url</span><span class="p">,</span> <span class="n">url</span><span class="p">.</span><span class="nf">split</span><span class="p">(</span><span class="sh">'</span><span class="s">/</span><span class="sh">'</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
</code></pre></div> </div> <p>The local files can also be added to pandas dataframe used to track the urls.</p> <div class="language-python highlighter-rouge"> <div class="highlight"><pre class="highlight"><code><span class="n">taxi_df</span><span class="p">[</span><span class="sh">'</span><span class="s">filename</span><span class="sh">'</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="n">url</span><span class="p">.</span><span class="nf">split</span><span class="p">(</span><span class="sh">'</span><span class="s">/</span><span class="sh">'</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="k">for</span> <span class="n">url</span> <span class="ow">in</span> <span class="n">taxi_df</span><span class="p">.</span><span class="n">data_url</span><span class="p">]</span>
</code></pre></div> </div> </details> <p><br></p> <p>Once the data is downloaded, we can check the total size of the dataset by accessing the parquet metadata, <a href="https://duckdb.org/docs/data/parquet/metadata" target="_blank" rel="noopener noreferrer">more info available here</a>.</p> <div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">total_size_GB</span> <span class="o">=</span> <span class="n">duckdb</span><span class="p">.</span><span class="nf">execute</span><span class="p">(</span><span class="sa">f</span><span class="sh">"""</span><span class="s">
SELECT SUM(total_compressed_size)/(1024*1024*1024) FROM parquet_metadata(</span><span class="si">{</span><span class="nf">list</span><span class="p">(</span><span class="n">taxi_df</span><span class="p">.</span><span class="n">filename</span><span class="p">)</span><span class="si">}</span><span class="s">)
</span><span class="sh">"""</span><span class="p">).</span><span class="nf">fetchall</span><span class="p">()[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>

<span class="n">total_size_uncompressed_GB</span> <span class="o">=</span> <span class="n">duckdb</span><span class="p">.</span><span class="nf">execute</span><span class="p">(</span><span class="sa">f</span><span class="sh">"""</span><span class="s">
SELECT SUM(total_uncompressed_size)/(1024*1024*1024) FROM parquet_metadata(</span><span class="si">{</span><span class="nf">list</span><span class="p">(</span><span class="n">taxi_df</span><span class="p">.</span><span class="n">filename</span><span class="p">)</span><span class="si">}</span><span class="s">)
</span><span class="sh">"""</span><span class="p">).</span><span class="nf">fetchall</span><span class="p">()[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>

<span class="nf">print</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="s">Total size of all files (compressed size): </span><span class="se">\t</span><span class="s"> </span><span class="si">{</span><span class="n">total_size_GB</span><span class="si">:</span><span class="p">.</span><span class="mi">2</span><span class="n">f</span><span class="si">}</span><span class="s"> GB</span><span class="sh">"</span><span class="p">)</span>
<span class="nf">print</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="s">Total uncompressed size (pandas in memory): </span><span class="se">\t</span><span class="s"> </span><span class="si">{</span><span class="n">total_size_uncompressed_GB</span><span class="si">:</span><span class="p">.</span><span class="mi">2</span><span class="n">f</span><span class="si">}</span><span class="s"> GB</span><span class="sh">"</span><span class="p">)</span>
</code></pre></div></div> <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>Total size of all files (compressed size): 	 27.99 GB
Total uncompressed size (pandas in memory): 	 59.40 GB
</code></pre></div></div> <p>With a total size of all files about 28 GB, this dataset is too large to store in memory (at least on my personal computer). Especially since the uncompressed size is over twice that size at 59.4 GB. It also highlights that parquet is a compressed data format, which can save disk space for columns with many repeating or empty values.</p> <h2 id="investigate-columns---whats-the-data">Investigate Columns - What‚Äôs The Data?</h2> <p>With the data downloaded, let‚Äôs take look at the schema and see if it is consistent across all of the parquet files. If the schema does differ, DuckDB provides the ability to handling unions, with either <code class="language-plaintext highlighter-rouge">union_by_name</code> or <code class="language-plaintext highlighter-rouge">union_by_position</code> (see more <a href="https://duckdb.org/docs/data/multiple_files/combining_schemas.html#:~:text=DuckDB%20offers%20two%20ways%20of,files%20have%20the%20same%20schema." target="_blank" rel="noopener noreferrer">here</a>).</p> <div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">col_vals</span> <span class="o">=</span> <span class="n">duckdb</span><span class="p">.</span><span class="nf">execute</span><span class="p">(</span><span class="sa">f</span><span class="sh">"""</span><span class="s">
SELECT file_name, path_in_schema FROM parquet_metadata(</span><span class="si">{</span><span class="nf">list</span><span class="p">(</span><span class="n">taxi_df</span><span class="p">.</span><span class="n">filename</span><span class="p">)</span><span class="si">}</span><span class="s">)
</span><span class="sh">"""</span><span class="p">).</span><span class="nf">df</span><span class="p">()</span>
</code></pre></div></div> <p>We can see which columns are available in each dataset. Let‚Äôs group by case insensitive column names, since SQL column variables are case insensitive.</p> <div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">grouped_col_names</span> <span class="o">=</span> <span class="n">col_vals</span><span class="p">.</span><span class="nf">groupby</span><span class="p">(</span><span class="n">col_vals</span><span class="p">[</span><span class="sh">'</span><span class="s">path_in_schema</span><span class="sh">'</span><span class="p">].</span><span class="nb">str</span><span class="p">.</span><span class="nf">lower</span><span class="p">())</span>\
                            <span class="p">.</span><span class="nf">agg</span><span class="p">([</span><span class="sh">'</span><span class="s">unique</span><span class="sh">'</span><span class="p">])</span>\
                            <span class="p">.</span><span class="nf">reset_index</span><span class="p">()</span>
</code></pre></div></div> <div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">grouped_col_names</span><span class="p">.</span><span class="nf">head</span><span class="p">()</span>
</code></pre></div></div> <div> <style scoped="">.dataframe tbody tr th:only-of-type{vertical-align:middle}.dataframe tbody tr th{vertical-align:top}.dataframe thead tr th{text-align:left}</style> <table border="1" class="dataframe"> <thead> <tr> <th></th> <th>path_in_schema</th> <th>file_name</th> <th>path_in_schema</th> </tr> <tr> <th></th> <th></th> <th>unique</th> <th>unique</th> </tr> </thead> <tbody> <tr> <th>0</th> <td>__index_level_0__</td> <td>[yellow_tripdata_2010-02.parquet, yellow_tripd...</td> <td>[__index_level_0__]</td> </tr> <tr> <th>1</th> <td>airport_fee</td> <td>[yellow_tripdata_2011-01.parquet, yellow_tripd...</td> <td>[airport_fee, Airport_fee]</td> </tr> <tr> <th>2</th> <td>congestion_surcharge</td> <td>[yellow_tripdata_2011-01.parquet, yellow_tripd...</td> <td>[congestion_surcharge]</td> </tr> <tr> <th>3</th> <td>dolocationid</td> <td>[yellow_tripdata_2011-01.parquet, yellow_tripd...</td> <td>[DOLocationID]</td> </tr> <tr> <th>4</th> <td>dropoff_datetime</td> <td>[yellow_tripdata_2010-01.parquet, yellow_tripd...</td> <td>[dropoff_datetime]</td> </tr> </tbody> </table> </div> <p><br></p> <p>And we can find the coverage of variable names across datasets by checking which files each column appears in.</p> <div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">all_files</span> <span class="o">=</span> <span class="nf">set</span><span class="p">(</span><span class="n">taxi_df</span><span class="p">.</span><span class="n">filename</span><span class="p">.</span><span class="n">values</span><span class="p">)</span>

<span class="n">coverage</span> <span class="o">=</span>  <span class="p">[</span>
    <span class="nf">len</span><span class="p">(</span>
        <span class="n">all_files</span><span class="p">.</span><span class="nf">intersection</span><span class="p">(</span><span class="nf">set</span><span class="p">(</span><span class="n">grouped_col_names</span><span class="p">[</span><span class="sh">'</span><span class="s">file_name</span><span class="sh">'</span><span class="p">][</span><span class="sh">'</span><span class="s">unique</span><span class="sh">'</span><span class="p">].</span><span class="n">iloc</span><span class="p">[</span><span class="n">i</span><span class="p">]))</span>
    <span class="p">)</span><span class="o">/</span><span class="nf">len</span><span class="p">(</span><span class="n">all_files</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nf">range</span><span class="p">(</span><span class="n">grouped_col_names</span><span class="p">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
<span class="p">]</span>
</code></pre></div></div> <div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">grouped_col_names</span><span class="p">[</span><span class="sh">'</span><span class="s">coverage</span><span class="sh">'</span><span class="p">]</span> <span class="o">=</span> <span class="n">coverage</span>
</code></pre></div></div> <p>We can see columns that appear in the largest fraction of parquet files.</p> <div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">grouped_col_names</span><span class="p">.</span><span class="nf">sort_values</span><span class="p">(</span><span class="n">by</span><span class="o">=</span><span class="sh">'</span><span class="s">coverage</span><span class="sh">'</span><span class="p">,</span><span class="n">ascending</span><span class="o">=</span><span class="bp">False</span><span class="p">).</span><span class="nf">head</span><span class="p">(</span><span class="mi">10</span><span class="p">)</span>
</code></pre></div></div> <div> <style scoped="">.dataframe tbody tr th:only-of-type{vertical-align:middle}.dataframe tbody tr th{vertical-align:top}.dataframe thead tr th{text-align:left}</style> <table border="1" class="dataframe"> <thead> <tr> <th></th> <th>path_in_schema</th> <th>file_name</th> <th>path_in_schema</th> <th>coverage</th> </tr> <tr> <th></th> <th></th> <th>unique</th> <th>unique</th> <th></th> </tr> </thead> <tbody> <tr> <th>35</th> <td>trip_distance</td> <td>[yellow_tripdata_2009-01.parquet, yellow_tripd...</td> <td>[Trip_Distance, trip_distance]</td> <td>1.000000</td> </tr> <tr> <th>15</th> <td>payment_type</td> <td>[yellow_tripdata_2009-01.parquet, yellow_tripd...</td> <td>[Payment_Type, payment_type]</td> <td>1.000000</td> </tr> <tr> <th>14</th> <td>passenger_count</td> <td>[yellow_tripdata_2009-01.parquet, yellow_tripd...</td> <td>[Passenger_Count, passenger_count]</td> <td>1.000000</td> </tr> <tr> <th>13</th> <td>mta_tax</td> <td>[yellow_tripdata_2009-01.parquet, yellow_tripd...</td> <td>[mta_tax]</td> <td>1.000000</td> </tr> <tr> <th>10</th> <td>fare_amount</td> <td>[yellow_tripdata_2010-01.parquet, yellow_tripd...</td> <td>[fare_amount]</td> <td>0.931429</td> </tr> <tr> <th>27</th> <td>tip_amount</td> <td>[yellow_tripdata_2010-01.parquet, yellow_tripd...</td> <td>[tip_amount]</td> <td>0.931429</td> </tr> <tr> <th>25</th> <td>store_and_fwd_flag</td> <td>[yellow_tripdata_2010-01.parquet, yellow_tripd...</td> <td>[store_and_fwd_flag]</td> <td>0.931429</td> </tr> <tr> <th>31</th> <td>total_amount</td> <td>[yellow_tripdata_2010-01.parquet, yellow_tripd...</td> <td>[total_amount]</td> <td>0.931429</td> </tr> <tr> <th>29</th> <td>tolls_amount</td> <td>[yellow_tripdata_2010-01.parquet, yellow_tripd...</td> <td>[tolls_amount]</td> <td>0.931429</td> </tr> <tr> <th>21</th> <td>ratecodeid</td> <td>[yellow_tripdata_2011-01.parquet, yellow_tripd...</td> <td>[RatecodeID]</td> <td>0.862857</td> </tr> </tbody> </table> </div> <p>And those appearing the smallest fraction of parquet files.</p> <div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">grouped_col_names</span><span class="p">.</span><span class="nf">sort_values</span><span class="p">(</span><span class="n">by</span><span class="o">=</span><span class="sh">'</span><span class="s">coverage</span><span class="sh">'</span><span class="p">,</span><span class="n">ascending</span><span class="o">=</span><span class="bp">False</span><span class="p">).</span><span class="nf">tail</span><span class="p">(</span><span class="mi">10</span><span class="p">)</span>
</code></pre></div></div> <div> <style scoped="">.dataframe tbody tr th:only-of-type{vertical-align:middle}.dataframe tbody tr th{vertical-align:top}.dataframe thead tr th{text-align:left}</style> <table border="1" class="dataframe"> <thead> <tr> <th></th> <th>path_in_schema</th> <th>file_name</th> <th>path_in_schema</th> <th>coverage</th> </tr> <tr> <th></th> <th></th> <th>unique</th> <th>unique</th> <th></th> </tr> </thead> <tbody> <tr> <th>7</th> <td>end_lat</td> <td>[yellow_tripdata_2009-01.parquet, yellow_tripd...</td> <td>[End_Lat]</td> <td>0.068571</td> </tr> <tr> <th>30</th> <td>tolls_amt</td> <td>[yellow_tripdata_2009-01.parquet, yellow_tripd...</td> <td>[Tolls_Amt]</td> <td>0.068571</td> </tr> <tr> <th>8</th> <td>end_lon</td> <td>[yellow_tripdata_2009-01.parquet, yellow_tripd...</td> <td>[End_Lon]</td> <td>0.068571</td> </tr> <tr> <th>28</th> <td>tip_amt</td> <td>[yellow_tripdata_2009-01.parquet, yellow_tripd...</td> <td>[Tip_Amt]</td> <td>0.068571</td> </tr> <tr> <th>11</th> <td>fare_amt</td> <td>[yellow_tripdata_2009-01.parquet, yellow_tripd...</td> <td>[Fare_Amt]</td> <td>0.068571</td> </tr> <tr> <th>16</th> <td>pickup_datetime</td> <td>[yellow_tripdata_2010-01.parquet, yellow_tripd...</td> <td>[pickup_datetime]</td> <td>0.068571</td> </tr> <tr> <th>17</th> <td>pickup_latitude</td> <td>[yellow_tripdata_2010-01.parquet, yellow_tripd...</td> <td>[pickup_latitude]</td> <td>0.068571</td> </tr> <tr> <th>24</th> <td>store_and_forward</td> <td>[yellow_tripdata_2009-01.parquet, yellow_tripd...</td> <td>[store_and_forward]</td> <td>0.068571</td> </tr> <tr> <th>23</th> <td>start_lon</td> <td>[yellow_tripdata_2009-01.parquet, yellow_tripd...</td> <td>[Start_Lon]</td> <td>0.068571</td> </tr> <tr> <th>0</th> <td>__index_level_0__</td> <td>[yellow_tripdata_2010-02.parquet, yellow_tripd...</td> <td>[__index_level_0__]</td> <td>0.011429</td> </tr> </tbody> </table> </div> <p>For reference the most recent documentation of the schema is provided by the NYC Taxi and Limousine Comission <a href="https://www.nyc.gov/assets/tlc/downloads/pdf/data_dictionary_trip_records_yellow.pdf" target="_blank" rel="noopener noreferrer">here</a>, but it is obvious from the above investigation that this schema has changed over time.</p> <h2 id="duckdb-queries">DuckDB Queries</h2> <p>Up until now I‚Äôve been dealing with the metadata of parquet files, which can be read into memory without reading in the entire parquet file. So the following demonstrations are the first which would be difficult to perform with this large of a dataset on a single machine without a streaming approach.</p> <h4 id="number-of-entries">Number of entries</h4> <p>First we can do a quick count of how many rows we have in all of our parquet files</p> <div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">total_rows</span> <span class="o">=</span> <span class="n">duckdb</span><span class="p">.</span><span class="nf">execute</span><span class="p">(</span><span class="sa">f</span><span class="sh">"""</span><span class="s">
SELECT COUNT(*) FROM read_parquet(</span><span class="si">{</span><span class="nf">list</span><span class="p">(</span><span class="n">taxi_df</span><span class="p">.</span><span class="n">filename</span><span class="p">)</span><span class="si">}</span><span class="s">)
</span><span class="sh">"""</span><span class="p">).</span><span class="nf">fetchall</span><span class="p">()[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>

<span class="nf">print</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="s">Total number of rows </span><span class="si">{</span><span class="n">total_rows</span><span class="si">:</span><span class="p">.</span><span class="mi">2</span><span class="n">e</span><span class="si">}</span><span class="sh">"</span><span class="p">)</span>
</code></pre></div></div> <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>Total number of rows 1.72e+09
</code></pre></div></div> <p>So we have over one billion records of taxi trips over the past 14 years. That‚Äôs a lot of taxi rides!</p> <h4 id="aggregation-methods">Aggregation Methods</h4> <p>Next let‚Äôs get percentiles on the <code class="language-plaintext highlighter-rouge">total_amount</code> field. DuckDB has a collection of <a href="https://duckdb.org/docs/sql/aggregates.html" target="_blank" rel="noopener noreferrer">aggregation functions</a> which perform calculations in parallel <strong>as the data is scanned</strong>, which does not require loading the full dataset into memory. We‚Äôll start off with the <code class="language-plaintext highlighter-rouge">approx_quantile</code> method, which calculates quantiles using the new <a href="https://github.com/tdunning/t-digest" target="_blank" rel="noopener noreferrer">T-Digest</a> method.</p> <p>Since <code class="language-plaintext highlighter-rouge">total_amount</code> is not present in all parquet files, we need to pass the <code class="language-plaintext highlighter-rouge">union_by_name=true</code> to the <code class="language-plaintext highlighter-rouge">read_parquet</code> method.</p> <div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># disable so it doesn't show up in markdown after nbconvert
</span><span class="n">duckdb</span><span class="p">.</span><span class="nf">execute</span><span class="p">(</span><span class="sh">"</span><span class="s">PRAGMA disable_progress_bar;</span><span class="sh">"</span><span class="p">);</span>
</code></pre></div></div> <div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">percentiles</span> <span class="o">=</span> <span class="n">np</span><span class="p">.</span><span class="nf">linspace</span><span class="p">(</span><span class="mf">0.01</span><span class="p">,</span><span class="mf">0.99</span><span class="p">,</span><span class="n">num</span><span class="o">=</span><span class="mi">99</span><span class="p">)</span>
</code></pre></div></div> <div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">total_amount_pctiles</span> <span class="o">=</span> <span class="n">duckdb</span><span class="p">.</span><span class="nf">execute</span><span class="p">(</span><span class="sa">f</span><span class="sh">"""</span><span class="s">
SELECT approx_quantile(total_amount,[</span><span class="si">{</span><span class="sh">"</span><span class="s">,</span><span class="sh">"</span><span class="p">.</span><span class="nf">join</span><span class="p">([</span><span class="nf">str</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">percentiles</span><span class="p">])</span><span class="si">}</span><span class="s">]) 
FROM read_parquet(</span><span class="si">{</span><span class="nf">list</span><span class="p">(</span><span class="n">taxi_df</span><span class="p">.</span><span class="n">filename</span><span class="p">)</span><span class="si">}</span><span class="s">,union_by_name=true)
WHERE total_amount &gt; 0
</span><span class="sh">"""</span><span class="p">).</span><span class="nf">fetchall</span><span class="p">()[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
</code></pre></div></div> <details> <summary> Plot distribution of ride costs over entire dataset </summary> <div class="language-python highlighter-rouge"> <div class="highlight"><pre class="highlight"><code><span class="n">plt</span><span class="p">.</span><span class="nf">plot</span><span class="p">(</span><span class="n">total_amount_pctiles</span><span class="p">,</span><span class="n">percentiles</span><span class="p">,</span><span class="n">linewidth</span><span class="o">=</span><span class="mi">3</span><span class="p">)</span>
<span class="n">plt</span><span class="p">.</span><span class="nf">xlabel</span><span class="p">(</span><span class="sh">'</span><span class="s">Ride Cost (Dollars)</span><span class="sh">'</span><span class="p">,</span><span class="n">size</span><span class="o">=</span><span class="mi">16</span><span class="p">)</span>
<span class="n">plt</span><span class="p">.</span><span class="nf">ylabel</span><span class="p">(</span><span class="sh">'</span><span class="s">Percentile</span><span class="sh">'</span><span class="p">,</span><span class="n">size</span><span class="o">=</span><span class="mi">16</span><span class="p">)</span>
<span class="n">plt</span><span class="p">.</span><span class="nf">grid</span><span class="p">(</span><span class="n">alpha</span><span class="o">=</span><span class="mf">0.2</span><span class="p">)</span>
<span class="n">plt</span><span class="p">.</span><span class="nf">xticks</span><span class="p">(</span><span class="n">fontsize</span><span class="o">=</span><span class="mi">16</span><span class="p">)</span>
<span class="n">plt</span><span class="p">.</span><span class="nf">yticks</span><span class="p">(</span><span class="n">fontsize</span><span class="o">=</span><span class="mi">16</span><span class="p">)</span>
<span class="n">plt</span><span class="p">.</span><span class="nf">gca</span><span class="p">().</span><span class="n">yaxis</span><span class="p">.</span><span class="nf">set_major_formatter</span><span class="p">(</span><span class="nc">PercentFormatter</span><span class="p">(</span><span class="mi">1</span><span class="p">))</span>
<span class="n">plt</span><span class="p">.</span><span class="nf">title</span><span class="p">(</span><span class="sh">'</span><span class="s">Ride Cost For Yellow Taxi over 2009-2023</span><span class="sh">'</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="mi">16</span><span class="p">)</span>
<span class="n">plt</span><span class="p">.</span><span class="nf">show</span><span class="p">()</span>
</code></pre></div> </div> </details> <p><br></p> <figure> <img src="/assets/img/blogs/DuckDB/duckdb_taxi_36_0.png" width="80%"> </figure> <h4 id="view-evolution-of-ride-cost-on-a-per-year-basis">View evolution of ride cost on a per year basis</h4> <p>With that out of the way, we can use the year information in the filename to plot the evolution of the cost of ride cost over the years</p> <div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">pcts_over_years</span> <span class="o">=</span> <span class="nf">dict</span><span class="p">()</span>
<span class="k">for</span> <span class="n">year</span> <span class="ow">in</span> <span class="nf">range</span><span class="p">(</span><span class="mi">2010</span><span class="p">,</span><span class="mi">2024</span><span class="p">,</span><span class="mi">1</span><span class="p">):</span>
    <span class="n">year_fnames</span> <span class="o">=</span> <span class="n">taxi_df</span><span class="p">[</span><span class="n">taxi_df</span><span class="p">[</span><span class="sh">'</span><span class="s">year</span><span class="sh">'</span><span class="p">]</span><span class="o">==</span><span class="n">year</span><span class="p">][</span><span class="sh">'</span><span class="s">filename</span><span class="sh">'</span><span class="p">]</span>
    <span class="n">year_pcts</span> <span class="o">=</span> <span class="n">duckdb</span><span class="p">.</span><span class="nf">execute</span><span class="p">(</span><span class="sa">f</span><span class="sh">"""</span><span class="s">
    SELECT approx_quantile(total_amount,[</span><span class="si">{</span><span class="sh">"</span><span class="s">,</span><span class="sh">"</span><span class="p">.</span><span class="nf">join</span><span class="p">([</span><span class="nf">str</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">percentiles</span><span class="p">])</span><span class="si">}</span><span class="s">]) 
    FROM read_parquet(</span><span class="si">{</span><span class="nf">list</span><span class="p">(</span><span class="n">year_fnames</span><span class="p">)</span><span class="si">}</span><span class="s">,union_by_name=true)
    WHERE total_amount &gt; 0</span><span class="sh">"""</span><span class="p">).</span><span class="nf">fetchall</span><span class="p">()[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">year_dict</span> <span class="o">=</span> <span class="p">{</span> <span class="nf">str</span><span class="p">(</span><span class="n">year</span><span class="p">):</span><span class="n">year_pcts</span> <span class="p">}</span>
    <span class="n">pcts_over_years</span> <span class="o">=</span> <span class="nf">dict</span><span class="p">(</span><span class="n">pcts_over_years</span><span class="p">,</span> <span class="o">**</span><span class="n">year_dict</span><span class="p">)</span>
</code></pre></div></div> <details> <summary> Plot total fare distribution per year </summary> <div class="language-python highlighter-rouge"> <div class="highlight"><pre class="highlight"><code><span class="n">colors</span> <span class="o">=</span> <span class="n">pl</span><span class="p">.</span><span class="n">cm</span><span class="p">.</span><span class="nf">magma</span><span class="p">(</span><span class="n">np</span><span class="p">.</span><span class="nf">linspace</span><span class="p">(.</span><span class="mi">1</span><span class="p">,.</span><span class="mi">7</span><span class="p">,</span><span class="nf">len</span><span class="p">(</span><span class="n">pcts_over_years</span><span class="p">.</span><span class="nf">keys</span><span class="p">())))</span>

<span class="k">for</span> <span class="n">idx</span><span class="p">,</span> <span class="n">year</span> <span class="ow">in</span> <span class="nf">enumerate</span><span class="p">(</span><span class="n">pcts_over_years</span><span class="p">):</span>
    <span class="n">plt</span><span class="p">.</span><span class="nf">plot</span><span class="p">(</span><span class="n">pcts_over_years</span><span class="p">[</span><span class="n">year</span><span class="p">],</span><span class="n">percentiles</span><span class="p">,</span><span class="n">label</span><span class="o">=</span><span class="n">year</span><span class="p">,</span><span class="n">alpha</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span><span class="n">color</span><span class="o">=</span><span class="n">colors</span><span class="p">[</span><span class="n">idx</span><span class="p">],</span><span class="n">linewidth</span><span class="o">=</span><span class="mi">3</span><span class="p">)</span>

<span class="n">plt</span><span class="p">.</span><span class="nf">title</span><span class="p">(</span><span class="sh">'</span><span class="s">Yellow Taxi Ride Cost Distribution 2010-2023</span><span class="sh">'</span><span class="p">,</span><span class="n">size</span><span class="o">=</span><span class="mi">16</span><span class="p">)</span>
<span class="n">plt</span><span class="p">.</span><span class="nf">xlabel</span><span class="p">(</span><span class="sh">'</span><span class="s">Ride Cost (Dollars)</span><span class="sh">'</span><span class="p">,</span><span class="n">size</span><span class="o">=</span><span class="mi">16</span><span class="p">)</span>
<span class="n">plt</span><span class="p">.</span><span class="nf">ylabel</span><span class="p">(</span><span class="sh">'</span><span class="s">Percentile</span><span class="sh">'</span><span class="p">,</span><span class="n">size</span><span class="o">=</span><span class="mi">16</span><span class="p">)</span>
<span class="n">plt</span><span class="p">.</span><span class="nf">grid</span><span class="p">(</span><span class="n">alpha</span><span class="o">=</span><span class="mf">0.2</span><span class="p">)</span>
<span class="n">plt</span><span class="p">.</span><span class="nf">xticks</span><span class="p">(</span><span class="n">fontsize</span><span class="o">=</span><span class="mi">16</span><span class="p">)</span>
<span class="n">plt</span><span class="p">.</span><span class="nf">yticks</span><span class="p">(</span><span class="n">fontsize</span><span class="o">=</span><span class="mi">16</span><span class="p">)</span>
<span class="n">plt</span><span class="p">.</span><span class="nf">gca</span><span class="p">().</span><span class="n">yaxis</span><span class="p">.</span><span class="nf">set_major_formatter</span><span class="p">(</span><span class="nc">PercentFormatter</span><span class="p">(</span><span class="mi">1</span><span class="p">))</span>
<span class="n">plt</span><span class="p">.</span><span class="nf">legend</span><span class="p">()</span>
<span class="n">plt</span><span class="p">.</span><span class="nf">show</span><span class="p">()</span>
</code></pre></div> </div> </details> <p><br></p> <figure> <img src="/assets/img/blogs/DuckDB/duckdb_taxi_39_0.png" width="80%"> </figure> <p>The above plot shows that the nominal cost of yellow taxi rides in NYC has steadily rising, but has increased significantly in the year 2023. This fits with the trend of higher inflation over the past couple years. If we wanted to investigate the breakdown of the total fare over time (taxes, tips, fees, etc.), those columns are in the dataset as well.</p> <h4 id="payment-types">Payment Types</h4> <p>Now let‚Äôs look at the counts of different payment types</p> <div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">payment_type_counts</span> <span class="o">=</span> <span class="n">duckdb</span><span class="p">.</span><span class="nf">execute</span><span class="p">(</span><span class="sa">f</span><span class="sh">"""</span><span class="s">
SELECT payment_type, COUNT(*) as occurrence_count
FROM read_parquet(</span><span class="si">{</span><span class="nf">list</span><span class="p">(</span><span class="n">taxi_df</span><span class="p">.</span><span class="n">filename</span><span class="p">)</span><span class="si">}</span><span class="s">,union_by_name=true)
GROUP BY payment_type; </span><span class="sh">"""</span><span class="p">).</span><span class="nf">df</span><span class="p">()</span>
</code></pre></div></div> <div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">payment_type_counts</span><span class="p">.</span><span class="nf">sort_values</span><span class="p">(</span><span class="n">by</span><span class="o">=</span><span class="p">[</span><span class="sh">'</span><span class="s">occurrence_count</span><span class="sh">'</span><span class="p">],</span><span class="n">ascending</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>
</code></pre></div></div> <div> <style scoped="">.dataframe tbody tr th:only-of-type{vertical-align:middle}.dataframe tbody tr th{vertical-align:top}.dataframe thead th{text-align:right}</style> <table border="1" class="dataframe"> <thead> <tr style="text-align: right;"> <th></th> <th>Payment_Type</th> <th>occurrence_count</th> </tr> </thead> <tbody> <tr> <th>5</th> <td>1</td> <td>821291745</td> </tr> <tr> <th>18</th> <td>2</td> <td>548052362</td> </tr> <tr> <th>20</th> <td>CASH</td> <td>69117503</td> </tr> <tr> <th>17</th> <td>Cash</td> <td>56282593</td> </tr> <tr> <th>6</th> <td>CSH</td> <td>50210641</td> </tr> <tr> <th>3</th> <td>Credit</td> <td>42561382</td> </tr> <tr> <th>12</th> <td>CRD</td> <td>30829647</td> </tr> <tr> <th>4</th> <td>CAS</td> <td>30792977</td> </tr> <tr> <th>16</th> <td>Cre</td> <td>27416855</td> </tr> <tr> <th>2</th> <td>Cas</td> <td>26058725</td> </tr> <tr> <th>19</th> <td>0</td> <td>4773430</td> </tr> <tr> <th>13</th> <td>3</td> <td>4440736</td> </tr> <tr> <th>0</th> <td>CRE</td> <td>3370093</td> </tr> <tr> <th>10</th> <td>CREDIT</td> <td>2330599</td> </tr> <tr> <th>1</th> <td>4</td> <td>1949962</td> </tr> <tr> <th>14</th> <td>5</td> <td>753370</td> </tr> <tr> <th>9</th> <td>No Charge</td> <td>509194</td> </tr> <tr> <th>22</th> <td>No</td> <td>200505</td> </tr> <tr> <th>11</th> <td>Dispute</td> <td>94784</td> </tr> <tr> <th>8</th> <td>Dis</td> <td>43614</td> </tr> <tr> <th>21</th> <td>NA</td> <td>40013</td> </tr> <tr> <th>15</th> <td>NOC</td> <td>31817</td> </tr> <tr> <th>7</th> <td>DIS</td> <td>6275</td> </tr> </tbody> </table> </div> <p><br></p> <p>Like any real dataset, we have some messy data which is the result of human error and changing schemas. Looking at the official documentation, there are currently only six types of payment types with a numerical code for each:</p> <ul> <li>1 = Credit</li> <li>2 = Cash</li> <li>3 = No Charge</li> <li>4 = Dispute</li> <li>5 = Unknown</li> <li>6 = Voided Trip</li> </ul> <p>I‚Äôm interested in the trends of cash versus credit over time. Let‚Äôs hand clean this mess by matching the data to its intended value.</p> <div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">total_cash</span> <span class="o">=</span> <span class="n">duckdb</span><span class="p">.</span><span class="nf">execute</span><span class="p">(</span><span class="sa">f</span><span class="sh">"""</span><span class="s">
SELECT COUNT(*) FROM read_parquet(</span><span class="si">{</span><span class="nf">list</span><span class="p">(</span><span class="n">taxi_df</span><span class="p">.</span><span class="n">filename</span><span class="p">)</span><span class="si">}</span><span class="s">,union_by_name=true)
WHERE payment_type IN (2, </span><span class="sh">'</span><span class="s">CASH</span><span class="sh">'</span><span class="s">,</span><span class="sh">'</span><span class="s">Cash</span><span class="sh">'</span><span class="s">,</span><span class="sh">'</span><span class="s">CSH</span><span class="sh">'</span><span class="s">, </span><span class="sh">'</span><span class="s">CAS</span><span class="sh">'</span><span class="s">, </span><span class="sh">'</span><span class="s">Cas</span><span class="sh">'</span><span class="s">)
</span><span class="sh">"""</span><span class="p">).</span><span class="nf">fetchall</span><span class="p">()[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>

<span class="n">total_credit</span> <span class="o">=</span> <span class="n">duckdb</span><span class="p">.</span><span class="nf">execute</span><span class="p">(</span><span class="sa">f</span><span class="sh">"""</span><span class="s">
SELECT COUNT(*) FROM read_parquet(</span><span class="si">{</span><span class="nf">list</span><span class="p">(</span><span class="n">taxi_df</span><span class="p">.</span><span class="n">filename</span><span class="p">)</span><span class="si">}</span><span class="s">,union_by_name=true)
WHERE payment_type IN (1, </span><span class="sh">'</span><span class="s">Credit</span><span class="sh">'</span><span class="s">, </span><span class="sh">'</span><span class="s">CRD</span><span class="sh">'</span><span class="s">, </span><span class="sh">'</span><span class="s">Cre</span><span class="sh">'</span><span class="s">,</span><span class="sh">'</span><span class="s">CRE</span><span class="sh">'</span><span class="s">, </span><span class="sh">'</span><span class="s">CREDIT</span><span class="sh">'</span><span class="s">)
</span><span class="sh">"""</span><span class="p">).</span><span class="nf">fetchall</span><span class="p">()[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
</code></pre></div></div> <div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nf">print</span><span class="p">(</span><span class="sa">f</span><span class="sh">"""</span><span class="s">
Total Cash Transactions: </span><span class="se">\t\t</span><span class="si">{</span><span class="n">total_cash</span><span class="si">:</span><span class="p">.</span><span class="mi">2</span><span class="n">e</span><span class="si">}</span><span class="s">
Total Credit Transactions: </span><span class="se">\t\t</span><span class="si">{</span><span class="n">total_credit</span><span class="si">:</span><span class="p">.</span><span class="mi">2</span><span class="n">e</span><span class="si">}</span><span class="s">
Fraction of Total Transactions: </span><span class="se">\t</span><span class="si">{</span><span class="p">(</span><span class="n">total_cash</span><span class="o">+</span><span class="n">total_credit</span><span class="p">)</span><span class="o">/</span><span class="n">total_rows</span><span class="si">:</span><span class="p">.</span><span class="mi">6</span><span class="n">f</span><span class="si">}</span><span class="s">
</span><span class="sh">"""</span><span class="p">)</span>
</code></pre></div></div> <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>Total Cash Transactions: 		7.81e+08
Total Credit Transactions: 		9.28e+08
Fraction of Total Transactions: 	0.992538
</code></pre></div></div> <p>So there are slighlty more credit tranasctions over the entire dataset than cash transactions. And predictably ‚ÄúCash or Credit?‚Äù corresponding to 99.25% of all transactions. But how the proportion of cash versus credit evolve over time?</p> <div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">years</span> <span class="o">=</span> <span class="nf">list</span><span class="p">(</span><span class="nf">range</span><span class="p">(</span><span class="mi">2010</span><span class="p">,</span><span class="mi">2024</span><span class="p">,</span><span class="mi">1</span><span class="p">))</span>
<span class="n">cash_years</span> <span class="o">=</span> <span class="p">[]</span>
<span class="n">credit_years</span> <span class="o">=</span> <span class="p">[]</span>

<span class="k">for</span> <span class="n">year</span> <span class="ow">in</span> <span class="n">years</span><span class="p">:</span>
    <span class="n">year_fnames</span> <span class="o">=</span> <span class="n">taxi_df</span><span class="p">[</span><span class="n">taxi_df</span><span class="p">[</span><span class="sh">'</span><span class="s">year</span><span class="sh">'</span><span class="p">]</span><span class="o">==</span><span class="n">year</span><span class="p">][</span><span class="sh">'</span><span class="s">filename</span><span class="sh">'</span><span class="p">]</span>
    
    <span class="n">cash_years</span><span class="p">.</span><span class="nf">append</span><span class="p">(</span>
        <span class="n">duckdb</span><span class="p">.</span><span class="nf">execute</span><span class="p">(</span><span class="sa">f</span><span class="sh">"""</span><span class="s">
        SELECT COUNT(*) FROM read_parquet(</span><span class="si">{</span><span class="nf">list</span><span class="p">(</span><span class="n">year_fnames</span><span class="p">)</span><span class="si">}</span><span class="s">,union_by_name=true)
        WHERE payment_type IN (2, </span><span class="sh">'</span><span class="s">CASH</span><span class="sh">'</span><span class="s">,</span><span class="sh">'</span><span class="s">Cash</span><span class="sh">'</span><span class="s">,</span><span class="sh">'</span><span class="s">CSH</span><span class="sh">'</span><span class="s">, </span><span class="sh">'</span><span class="s">CAS</span><span class="sh">'</span><span class="s">, </span><span class="sh">'</span><span class="s">Cas</span><span class="sh">'</span><span class="s">)
        </span><span class="sh">"""</span><span class="p">).</span><span class="nf">fetchall</span><span class="p">()[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">])</span>

    <span class="n">credit_years</span><span class="p">.</span><span class="nf">append</span><span class="p">(</span>
        <span class="n">duckdb</span><span class="p">.</span><span class="nf">execute</span><span class="p">(</span><span class="sa">f</span><span class="sh">"""</span><span class="s">
        SELECT COUNT(*) FROM read_parquet(</span><span class="si">{</span><span class="nf">list</span><span class="p">(</span><span class="n">year_fnames</span><span class="p">)</span><span class="si">}</span><span class="s">,union_by_name=true)
        WHERE payment_type IN (1, </span><span class="sh">'</span><span class="s">Credit</span><span class="sh">'</span><span class="s">, </span><span class="sh">'</span><span class="s">CRD</span><span class="sh">'</span><span class="s">, </span><span class="sh">'</span><span class="s">Cre</span><span class="sh">'</span><span class="s">,</span><span class="sh">'</span><span class="s">CRE</span><span class="sh">'</span><span class="s">, </span><span class="sh">'</span><span class="s">CREDIT</span><span class="sh">'</span><span class="s">)
        </span><span class="sh">"""</span><span class="p">).</span><span class="nf">fetchall</span><span class="p">()[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">])</span>    
</code></pre></div></div> <details> <summary> Plot "Cash or Credit" annually over dataset" </summary> <div class="language-python highlighter-rouge"> <div class="highlight"><pre class="highlight"><code><span class="c1"># Total Transaction Volume
</span><span class="n">plt</span><span class="p">.</span><span class="nf">plot</span><span class="p">(</span><span class="n">years</span><span class="p">,</span><span class="n">cash_years</span><span class="p">,</span><span class="n">label</span><span class="o">=</span><span class="sh">'</span><span class="s">Cash Transactions</span><span class="sh">'</span><span class="p">,</span><span class="n">linewidth</span><span class="o">=</span><span class="mi">3</span><span class="p">)</span>
<span class="n">plt</span><span class="p">.</span><span class="nf">plot</span><span class="p">(</span><span class="n">years</span><span class="p">,</span><span class="n">credit_years</span><span class="p">,</span><span class="n">label</span><span class="o">=</span><span class="sh">'</span><span class="s">Credit Transactions</span><span class="sh">'</span><span class="p">,</span><span class="n">linewidth</span><span class="o">=</span><span class="mi">3</span><span class="p">)</span>
<span class="n">plt</span><span class="p">.</span><span class="nf">plot</span><span class="p">(</span><span class="n">years</span><span class="p">,</span><span class="n">np</span><span class="p">.</span><span class="nf">add</span><span class="p">(</span><span class="n">cash_years</span><span class="p">,</span><span class="n">credit_years</span><span class="p">),</span><span class="n">label</span><span class="o">=</span><span class="sh">'</span><span class="s">Total Transactions</span><span class="sh">'</span><span class="p">,</span><span class="n">linewidth</span><span class="o">=</span><span class="mi">3</span><span class="p">)</span>

<span class="n">plt</span><span class="p">.</span><span class="nf">xlabel</span><span class="p">(</span><span class="sh">'</span><span class="s">Year</span><span class="sh">'</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="mi">16</span><span class="p">)</span>
<span class="n">plt</span><span class="p">.</span><span class="nf">ylabel</span><span class="p">(</span><span class="sh">'</span><span class="s">Annual Transactions</span><span class="sh">'</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="mi">16</span><span class="p">)</span>
<span class="n">plt</span><span class="p">.</span><span class="nf">title</span><span class="p">(</span><span class="sh">'</span><span class="s">NYC Taxi Rides - Cash vs. Credit Total Volume</span><span class="sh">'</span><span class="p">)</span>
<span class="n">plt</span><span class="p">.</span><span class="nf">legend</span><span class="p">()</span>
<span class="n">plt</span><span class="p">.</span><span class="nf">grid</span><span class="p">(</span><span class="n">alpha</span><span class="o">=</span><span class="mf">0.2</span><span class="p">)</span>
<span class="n">plt</span><span class="p">.</span><span class="nf">xticks</span><span class="p">(</span><span class="n">size</span><span class="o">=</span><span class="mi">14</span><span class="p">)</span>
<span class="n">plt</span><span class="p">.</span><span class="nf">yticks</span><span class="p">(</span><span class="n">size</span><span class="o">=</span><span class="mi">14</span><span class="p">)</span>
<span class="n">plt</span><span class="p">.</span><span class="nf">show</span><span class="p">()</span>
</code></pre></div> </div> </details> <p><br></p> <figure> <img src="/assets/img/blogs/DuckDB/duckdb_taxi_49_0.png" width="80%"> </figure> <details> <summary> Plot "Cash or Credit" as percentage of all transactions </summary> <div class="language-python highlighter-rouge"> <div class="highlight"><pre class="highlight"><code><span class="c1"># Transaction Percentage
</span><span class="n">plt</span><span class="p">.</span><span class="nf">plot</span><span class="p">(</span><span class="n">years</span><span class="p">,</span><span class="n">np</span><span class="p">.</span><span class="nf">divide</span><span class="p">(</span><span class="n">cash_years</span><span class="p">,</span><span class="n">np</span><span class="p">.</span><span class="nf">add</span><span class="p">(</span><span class="n">cash_years</span><span class="p">,</span><span class="n">credit_years</span><span class="p">)),</span><span class="n">label</span><span class="o">=</span><span class="sh">'</span><span class="s">Cash</span><span class="sh">'</span><span class="p">,</span><span class="n">linewidth</span><span class="o">=</span><span class="mi">3</span><span class="p">)</span>
<span class="n">plt</span><span class="p">.</span><span class="nf">plot</span><span class="p">(</span><span class="n">years</span><span class="p">,</span><span class="n">np</span><span class="p">.</span><span class="nf">divide</span><span class="p">(</span><span class="n">credit_years</span><span class="p">,</span><span class="n">np</span><span class="p">.</span><span class="nf">add</span><span class="p">(</span><span class="n">cash_years</span><span class="p">,</span><span class="n">credit_years</span><span class="p">)),</span><span class="n">label</span><span class="o">=</span><span class="sh">'</span><span class="s">Credit</span><span class="sh">'</span><span class="p">,</span><span class="n">linewidth</span><span class="o">=</span><span class="mi">3</span><span class="p">)</span>

<span class="n">plt</span><span class="p">.</span><span class="nf">xlabel</span><span class="p">(</span><span class="sh">'</span><span class="s">Year</span><span class="sh">'</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="mi">16</span><span class="p">)</span>
<span class="n">plt</span><span class="p">.</span><span class="nf">ylabel</span><span class="p">(</span><span class="sh">'</span><span class="s">Transaction Percentage</span><span class="sh">'</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="mi">16</span><span class="p">)</span>
<span class="n">plt</span><span class="p">.</span><span class="nf">title</span><span class="p">(</span><span class="sh">'</span><span class="s">NYC Taxi Rides - Cash vs. Credit Percentage</span><span class="sh">'</span><span class="p">)</span>
<span class="n">plt</span><span class="p">.</span><span class="nf">legend</span><span class="p">()</span>
<span class="n">plt</span><span class="p">.</span><span class="nf">gca</span><span class="p">().</span><span class="n">yaxis</span><span class="p">.</span><span class="nf">set_major_formatter</span><span class="p">(</span><span class="nc">PercentFormatter</span><span class="p">(</span><span class="mi">1</span><span class="p">))</span>
<span class="n">plt</span><span class="p">.</span><span class="nf">grid</span><span class="p">(</span><span class="n">alpha</span><span class="o">=</span><span class="mf">0.2</span><span class="p">)</span>
<span class="n">plt</span><span class="p">.</span><span class="nf">xticks</span><span class="p">(</span><span class="n">size</span><span class="o">=</span><span class="mi">14</span><span class="p">)</span>
<span class="n">plt</span><span class="p">.</span><span class="nf">yticks</span><span class="p">(</span><span class="n">size</span><span class="o">=</span><span class="mi">14</span><span class="p">)</span>
<span class="n">plt</span><span class="p">.</span><span class="nf">show</span><span class="p">()</span>
</code></pre></div> </div> </details> <p><br></p> <figure> <img src="/assets/img/blogs/DuckDB/duckdb_taxi_50_0.png" width="80%"> </figure> <h4 id="im-different---user-defined-functions">I‚Äôm Different - User Defined Functions</h4> <p>If the SQL queries and DuckDB aggregate functions are not enough for a given use case, DuckDB provides the ability to use User Defined Functions (UDF). With UDF‚Äôs, we can define pure python functions that are calculated <em>as the data is continously read</em>. So if the initial aggregation is still too large for memory, we can apply our own defined functions as the data is read in. It is especially cool that we can use third party libraries within the defined function! I‚Äôm assuming this works since DuckDB is bound to the particular python process being run.</p> <p>For this example, let‚Äôs do some random math where we take the absolute difference between two values and then calculate the square root with numpy. If we provide type annotation, DuckDB is smart enough to handle the rest. We just need to select columns where both values are not null so the query doesn‚Äôt error out.</p> <div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">def</span> <span class="nf">random_func</span><span class="p">(</span><span class="n">x</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span> <span class="n">y</span><span class="p">:</span> <span class="nb">float</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">float</span><span class="p">:</span>
    <span class="k">return</span> <span class="n">np</span><span class="p">.</span><span class="nf">sqrt</span><span class="p">(</span><span class="nf">abs</span><span class="p">(</span><span class="n">x</span><span class="o">-</span><span class="n">y</span><span class="p">))</span>

<span class="n">duckdb</span><span class="p">.</span><span class="nf">create_function</span><span class="p">(</span><span class="sh">'</span><span class="s">random_func</span><span class="sh">'</span><span class="p">,</span><span class="n">random_func</span><span class="p">);</span>
</code></pre></div></div> <p>Now let‚Äôs use the function in a query by applying the function to the <code class="language-plaintext highlighter-rouge">fare_amount</code> and <code class="language-plaintext highlighter-rouge">tip_amount</code> method.</p> <div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">random_ans</span> <span class="o">=</span> <span class="n">duckdb</span><span class="p">.</span><span class="nf">execute</span><span class="p">(</span><span class="sa">f</span><span class="sh">"""</span><span class="s">
        SELECT AVG(random_func(fare_amount,tip_amount)) FROM read_parquet(</span><span class="si">{</span><span class="nf">list</span><span class="p">(</span><span class="n">taxi_df</span><span class="p">.</span><span class="n">filename</span><span class="p">)</span><span class="si">}</span><span class="s">,union_by_name=true)
        WHERE tip_amount IS NOT NULL
        AND fare_amount IS NOT NULL
        </span><span class="sh">"""</span><span class="p">).</span><span class="nf">fetchall</span><span class="p">()[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
</code></pre></div></div> <div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nf">print</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="s">Average value of our random function </span><span class="si">{</span><span class="n">random_ans</span><span class="si">:</span><span class="p">.</span><span class="mi">2</span><span class="n">f</span><span class="si">}</span><span class="sh">"</span><span class="p">)</span>
</code></pre></div></div> <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>Average value of our random function 3.07
</code></pre></div></div> <p>Introducing this python function did cause the query to be much slower than previous operations. Unlike other queries which quickly brought my CPU usage up to 100%, this one kept my CPU at about 20% for the entire operation. So it is worth trying to avoid python UDFs as the data size becomes large or performance is important.</p> <h2 id="final-thoughts">Final Thoughts</h2> <p>After playing around with DuckDB for a bit, I‚Äôm pretty impressed. I think it has an obvious use case for analytical workloads where the data which is larger your computer‚Äôs memory, where performance is important, and where its simplicity outweighs potential gains from more heavyweight big data analysis services. Since DuckDB deals with databases in a column based format, I also think it is a natural candidate to process parquet files.</p> <h2 id="duckdb-performance">DuckDB Performance</h2> <p>Here are timed benchmarks for all queries performed above. As a reminder, the dataset is 28 GB compressed, 59 GB uncompressed, and has 1.72 billion rows.</p> <p>These numbers will depend on hardware, so for reference I have a <a href="https://www.amd.com/en/product/8456" target="_blank" rel="noopener noreferrer">AMD 3600</a> CPU and the data is stored on a <a href="https://semiconductor.samsung.com/us/consumer-storage/internal-ssd/970evoplus/" target="_blank" rel="noopener noreferrer">Samsung 970 EVO</a> SSD which has quoted read/write times of 3500 MB/s and 3,300 MB/s respectively. Based on these speeds, I would expect loading in all columns of all parquet files into memory to take at least 28 GB / 3.5 GB/s \(\approx\) 8 seconds <em>if</em> I had that much RAM (which I don‚Äôt). Most of the default DuckDB queries which require scanning the all files are on the same time scale of around 10 seconds or less. I‚Äôm assuming DuckDB can achieve these times because it can selectively load only the parts of the dataset it needs to execute the query.</p> <h4 id="query-getting-total-compressed-size-from-parquet-metadata"> <strong>Query:</strong> Getting total compressed size from parquet metadata</h4> <div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="o">%%</span><span class="n">timeit</span>

<span class="n">duckdb</span><span class="p">.</span><span class="nf">execute</span><span class="p">(</span><span class="sa">f</span><span class="sh">"""</span><span class="s">
SELECT SUM(total_compressed_size)/(1024*1024*1024) FROM parquet_metadata(</span><span class="si">{</span><span class="nf">list</span><span class="p">(</span><span class="n">taxi_df</span><span class="p">.</span><span class="n">filename</span><span class="p">)</span><span class="si">}</span><span class="s">)
</span><span class="sh">"""</span><span class="p">).</span><span class="nf">fetchall</span><span class="p">()[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
</code></pre></div></div> <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>79.5 ms ¬± 2.51 ms per loop (mean ¬± std. dev. of 7 runs, 1 loop each)
</code></pre></div></div> <h4 id="query-getting-total-uncompressed-size-from-parquet-metadata"> <strong>Query:</strong> Getting total uncompressed size from parquet metadata</h4> <div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="o">%%</span><span class="n">timeit</span>

<span class="n">duckdb</span><span class="p">.</span><span class="nf">execute</span><span class="p">(</span><span class="sa">f</span><span class="sh">"""</span><span class="s">
SELECT SUM(total_uncompressed_size)/(1024*1024*1024) FROM parquet_metadata(</span><span class="si">{</span><span class="nf">list</span><span class="p">(</span><span class="n">taxi_df</span><span class="p">.</span><span class="n">filename</span><span class="p">)</span><span class="si">}</span><span class="s">)
</span><span class="sh">"""</span><span class="p">).</span><span class="nf">fetchall</span><span class="p">()[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
</code></pre></div></div> <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>82.8 ms ¬± 2.42 ms per loop (mean ¬± std. dev. of 7 runs, 10 loops each)
</code></pre></div></div> <h4 id="query-getting-filename-and-column-names-from-metadata"> <strong>Query:</strong> Getting filename and column names from metadata</h4> <div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="o">%%</span><span class="n">timeit</span>

<span class="n">duckdb</span><span class="p">.</span><span class="nf">execute</span><span class="p">(</span><span class="sa">f</span><span class="sh">"""</span><span class="s">
SELECT file_name, path_in_schema FROM parquet_metadata(</span><span class="si">{</span><span class="nf">list</span><span class="p">(</span><span class="n">taxi_df</span><span class="p">.</span><span class="n">filename</span><span class="p">)</span><span class="si">}</span><span class="s">)
</span><span class="sh">"""</span><span class="p">).</span><span class="nf">df</span><span class="p">()</span>
</code></pre></div></div> <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>78 ms ¬± 194 ¬µs per loop (mean ¬± std. dev. of 7 runs, 10 loops each)
</code></pre></div></div> <h4 id="query-get-total-number-of-transactions"> <strong>Query:</strong> Get total number of transactions</h4> <div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="o">%%</span><span class="n">timeit</span>

<span class="n">duckdb</span><span class="p">.</span><span class="nf">execute</span><span class="p">(</span><span class="sa">f</span><span class="sh">"""</span><span class="s">
SELECT COUNT(*) FROM read_parquet(</span><span class="si">{</span><span class="nf">list</span><span class="p">(</span><span class="n">taxi_df</span><span class="p">.</span><span class="n">filename</span><span class="p">)</span><span class="si">}</span><span class="s">)
</span><span class="sh">"""</span><span class="p">).</span><span class="nf">fetchall</span><span class="p">()[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
</code></pre></div></div> <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>78.1 ms ¬± 304 ¬µs per loop (mean ¬± std. dev. of 7 runs, 10 loops each)
</code></pre></div></div> <h4 id="query-get-approx-percentiles-of-total-amount-column"> <strong>Query:</strong> Get Approx. Percentiles of Total Amount Column</h4> <div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="o">%%</span><span class="n">timeit</span>

<span class="n">duckdb</span><span class="p">.</span><span class="nf">execute</span><span class="p">(</span><span class="sa">f</span><span class="sh">"""</span><span class="s">
SELECT approx_quantile(total_amount,[</span><span class="si">{</span><span class="sh">"</span><span class="s">,</span><span class="sh">"</span><span class="p">.</span><span class="nf">join</span><span class="p">([</span><span class="nf">str</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">percentiles</span><span class="p">])</span><span class="si">}</span><span class="s">]) 
FROM read_parquet(</span><span class="si">{</span><span class="nf">list</span><span class="p">(</span><span class="n">taxi_df</span><span class="p">.</span><span class="n">filename</span><span class="p">)</span><span class="si">}</span><span class="s">,union_by_name=true)
WHERE total_amount &gt; 0
</span><span class="sh">"""</span><span class="p">).</span><span class="nf">fetchall</span><span class="p">()[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
</code></pre></div></div> <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>11.5 s ¬± 19.7 ms per loop (mean ¬± std. dev. of 7 runs, 1 loop each)
</code></pre></div></div> <h4 id="query-get-approx-percentiles-of-total-amount-column-per-year"> <strong>Query:</strong> Get Approx Percentiles of Total Amount Column Per Year</h4> <div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="o">%%</span><span class="n">timeit</span>

<span class="n">pcts_over_years</span> <span class="o">=</span> <span class="nf">dict</span><span class="p">()</span>
<span class="k">for</span> <span class="n">year</span> <span class="ow">in</span> <span class="nf">range</span><span class="p">(</span><span class="mi">2010</span><span class="p">,</span><span class="mi">2024</span><span class="p">,</span><span class="mi">1</span><span class="p">):</span>
    <span class="n">year_fnames</span> <span class="o">=</span> <span class="n">taxi_df</span><span class="p">[</span><span class="n">taxi_df</span><span class="p">[</span><span class="sh">'</span><span class="s">year</span><span class="sh">'</span><span class="p">]</span><span class="o">==</span><span class="n">year</span><span class="p">][</span><span class="sh">'</span><span class="s">filename</span><span class="sh">'</span><span class="p">]</span>
    <span class="n">year_pcts</span> <span class="o">=</span> <span class="n">duckdb</span><span class="p">.</span><span class="nf">execute</span><span class="p">(</span><span class="sa">f</span><span class="sh">"""</span><span class="s">
    SELECT approx_quantile(total_amount,[</span><span class="si">{</span><span class="sh">"</span><span class="s">,</span><span class="sh">"</span><span class="p">.</span><span class="nf">join</span><span class="p">([</span><span class="nf">str</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">percentiles</span><span class="p">])</span><span class="si">}</span><span class="s">]) 
    FROM read_parquet(</span><span class="si">{</span><span class="nf">list</span><span class="p">(</span><span class="n">year_fnames</span><span class="p">)</span><span class="si">}</span><span class="s">,union_by_name=true)
    WHERE total_amount &gt; 0</span><span class="sh">"""</span><span class="p">).</span><span class="nf">fetchall</span><span class="p">()[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">year_dict</span> <span class="o">=</span> <span class="p">{</span> <span class="nf">str</span><span class="p">(</span><span class="n">year</span><span class="p">):</span><span class="n">year_pcts</span> <span class="p">}</span>
    <span class="n">pcts_over_years</span> <span class="o">=</span> <span class="nf">dict</span><span class="p">(</span><span class="n">pcts_over_years</span><span class="p">,</span> <span class="o">**</span><span class="n">year_dict</span><span class="p">)</span>
</code></pre></div></div> <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>12.8 s ¬± 28.1 ms per loop (mean ¬± std. dev. of 7 runs, 1 loop each)
</code></pre></div></div> <h4 id="query-get-number-of-transactions-per-payment-type"> <strong>Query:</strong> Get Number of Transactions Per Payment Type</h4> <div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="o">%%</span><span class="n">timeit</span>

<span class="n">duckdb</span><span class="p">.</span><span class="nf">execute</span><span class="p">(</span><span class="sa">f</span><span class="sh">"""</span><span class="s">
SELECT payment_type, COUNT(*) as occurrence_count
FROM read_parquet(</span><span class="si">{</span><span class="nf">list</span><span class="p">(</span><span class="n">taxi_df</span><span class="p">.</span><span class="n">filename</span><span class="p">)</span><span class="si">}</span><span class="s">,union_by_name=true)
GROUP BY payment_type; </span><span class="sh">"""</span><span class="p">).</span><span class="nf">df</span><span class="p">()</span>
</code></pre></div></div> <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>5.73 s ¬± 38.9 ms per loop (mean ¬± std. dev. of 7 runs, 1 loop each)
</code></pre></div></div> <h4 id="query-get-number-of-cash-transactions-total"> <strong>Query:</strong> Get Number of Cash Transactions Total</h4> <div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="o">%%</span><span class="n">timeit</span>

<span class="n">total_cash</span> <span class="o">=</span> <span class="n">duckdb</span><span class="p">.</span><span class="nf">execute</span><span class="p">(</span><span class="sa">f</span><span class="sh">"""</span><span class="s">
SELECT COUNT(*) FROM read_parquet(</span><span class="si">{</span><span class="nf">list</span><span class="p">(</span><span class="n">taxi_df</span><span class="p">.</span><span class="n">filename</span><span class="p">)</span><span class="si">}</span><span class="s">,union_by_name=true)
WHERE payment_type IN (2, </span><span class="sh">'</span><span class="s">CASH</span><span class="sh">'</span><span class="s">,</span><span class="sh">'</span><span class="s">Cash</span><span class="sh">'</span><span class="s">,</span><span class="sh">'</span><span class="s">CSH</span><span class="sh">'</span><span class="s">, </span><span class="sh">'</span><span class="s">CAS</span><span class="sh">'</span><span class="s">, </span><span class="sh">'</span><span class="s">Cas</span><span class="sh">'</span><span class="s">)
</span><span class="sh">"""</span><span class="p">).</span><span class="nf">fetchall</span><span class="p">()[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
</code></pre></div></div> <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>6.4 s ¬± 21.4 ms per loop (mean ¬± std. dev. of 7 runs, 1 loop each)
</code></pre></div></div> <h4 id="query-get-number-of-credit-transactions-total"> <strong>Query:</strong> Get Number of Credit Transactions Total</h4> <div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="o">%%</span><span class="n">timeit</span>

<span class="n">duckdb</span><span class="p">.</span><span class="nf">execute</span><span class="p">(</span><span class="sa">f</span><span class="sh">"""</span><span class="s">
SELECT COUNT(*) FROM read_parquet(</span><span class="si">{</span><span class="nf">list</span><span class="p">(</span><span class="n">taxi_df</span><span class="p">.</span><span class="n">filename</span><span class="p">)</span><span class="si">}</span><span class="s">,union_by_name=true)
WHERE payment_type IN (1, </span><span class="sh">'</span><span class="s">Credit</span><span class="sh">'</span><span class="s">, </span><span class="sh">'</span><span class="s">CRD</span><span class="sh">'</span><span class="s">, </span><span class="sh">'</span><span class="s">Cre</span><span class="sh">'</span><span class="s">,</span><span class="sh">'</span><span class="s">CRE</span><span class="sh">'</span><span class="s">, </span><span class="sh">'</span><span class="s">CREDIT</span><span class="sh">'</span><span class="s">)
</span><span class="sh">"""</span><span class="p">).</span><span class="nf">fetchall</span><span class="p">()[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>  
</code></pre></div></div> <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>6.52 s ¬± 27.8 ms per loop (mean ¬± std. dev. of 7 runs, 1 loop each)
</code></pre></div></div> <h4 id="query-get-number-of-cashcredit-transactions-per-year"> <strong>Query:</strong> Get Number of Cash/Credit Transactions Per Year</h4> <div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="o">%%</span><span class="n">timeit</span>

<span class="n">years</span> <span class="o">=</span> <span class="nf">list</span><span class="p">(</span><span class="nf">range</span><span class="p">(</span><span class="mi">2010</span><span class="p">,</span><span class="mi">2024</span><span class="p">,</span><span class="mi">1</span><span class="p">))</span>
<span class="n">cash_years</span> <span class="o">=</span> <span class="p">[]</span>
<span class="n">credit_years</span> <span class="o">=</span> <span class="p">[]</span>

<span class="k">for</span> <span class="n">year</span> <span class="ow">in</span> <span class="n">years</span><span class="p">:</span>
    <span class="n">year_fnames</span> <span class="o">=</span> <span class="n">taxi_df</span><span class="p">[</span><span class="n">taxi_df</span><span class="p">[</span><span class="sh">'</span><span class="s">year</span><span class="sh">'</span><span class="p">]</span><span class="o">==</span><span class="n">year</span><span class="p">][</span><span class="sh">'</span><span class="s">filename</span><span class="sh">'</span><span class="p">]</span>
    
    <span class="n">cash_years</span><span class="p">.</span><span class="nf">append</span><span class="p">(</span>
        <span class="n">duckdb</span><span class="p">.</span><span class="nf">execute</span><span class="p">(</span><span class="sa">f</span><span class="sh">"""</span><span class="s">
        SELECT COUNT(*) FROM read_parquet(</span><span class="si">{</span><span class="nf">list</span><span class="p">(</span><span class="n">year_fnames</span><span class="p">)</span><span class="si">}</span><span class="s">,union_by_name=true)
        WHERE payment_type IN (2, </span><span class="sh">'</span><span class="s">CASH</span><span class="sh">'</span><span class="s">,</span><span class="sh">'</span><span class="s">Cash</span><span class="sh">'</span><span class="s">,</span><span class="sh">'</span><span class="s">CSH</span><span class="sh">'</span><span class="s">, </span><span class="sh">'</span><span class="s">CAS</span><span class="sh">'</span><span class="s">, </span><span class="sh">'</span><span class="s">Cas</span><span class="sh">'</span><span class="s">)
        </span><span class="sh">"""</span><span class="p">).</span><span class="nf">fetchall</span><span class="p">()[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">])</span>

    <span class="n">credit_years</span><span class="p">.</span><span class="nf">append</span><span class="p">(</span>
        <span class="n">duckdb</span><span class="p">.</span><span class="nf">execute</span><span class="p">(</span><span class="sa">f</span><span class="sh">"""</span><span class="s">
        SELECT COUNT(*) FROM read_parquet(</span><span class="si">{</span><span class="nf">list</span><span class="p">(</span><span class="n">year_fnames</span><span class="p">)</span><span class="si">}</span><span class="s">,union_by_name=true)
        WHERE payment_type IN (1, </span><span class="sh">'</span><span class="s">Credit</span><span class="sh">'</span><span class="s">, </span><span class="sh">'</span><span class="s">CRD</span><span class="sh">'</span><span class="s">, </span><span class="sh">'</span><span class="s">Cre</span><span class="sh">'</span><span class="s">,</span><span class="sh">'</span><span class="s">CRE</span><span class="sh">'</span><span class="s">, </span><span class="sh">'</span><span class="s">CREDIT</span><span class="sh">'</span><span class="s">)
        </span><span class="sh">"""</span><span class="p">).</span><span class="nf">fetchall</span><span class="p">()[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">])</span>    
</code></pre></div></div> <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>13.2 s ¬± 49.9 ms per loop (mean ¬± std. dev. of 7 runs, 1 loop each)
</code></pre></div></div> <h4 id="query-user-defined-function"> <strong>Query:</strong> User Defined Function</h4> <div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">#Got impatient since this is a really slow query
</span><span class="kn">from</span> <span class="n">timeit</span> <span class="kn">import</span> <span class="n">default_timer</span> <span class="k">as</span> <span class="n">timer</span>

<span class="n">start</span> <span class="o">=</span> <span class="nf">timer</span><span class="p">()</span>
<span class="n">duckdb</span><span class="p">.</span><span class="nf">execute</span><span class="p">(</span><span class="sa">f</span><span class="sh">"""</span><span class="s">
        SELECT AVG(random_func(fare_amount,tip_amount)) FROM read_parquet(</span><span class="si">{</span><span class="nf">list</span><span class="p">(</span><span class="n">taxi_df</span><span class="p">.</span><span class="n">filename</span><span class="p">)</span><span class="si">}</span><span class="s">,union_by_name=true)
        WHERE tip_amount IS NOT NULL
        AND fare_amount IS NOT NULL
        </span><span class="sh">"""</span><span class="p">).</span><span class="nf">fetchall</span><span class="p">()[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
<span class="n">end</span> <span class="o">=</span> <span class="nf">timer</span><span class="p">()</span>

<span class="nf">print</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="s">User Defined Function Took </span><span class="si">{</span><span class="n">end</span><span class="o">-</span><span class="n">start</span><span class="si">:</span><span class="p">.</span><span class="mi">2</span><span class="n">e</span><span class="si">}</span><span class="s"> seconds</span><span class="sh">"</span><span class="p">)</span>
</code></pre></div></div> <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>User Defined Function Took 2.09e+03 seconds
</code></pre></div></div> <p>Which is about 35 minutes.</p> </article> </div> </div> <footer class="fixed-bottom"> <div class="container mt-0"> ¬© Copyright 2023 Sean T. Howard. Powered by <a href="https://jekyllrb.com/" target="_blank" rel="noopener noreferrer">Jekyll</a> with <a href="https://github.com/alshedivat/al-folio" target="_blank" rel="noopener noreferrer">al-folio</a> theme. </div> </footer> <script src="https://cdn.jsdelivr.net/npm/jquery@3.6.0/dist/jquery.min.js" integrity="sha256-/xUj+3OJU5yExlq6GSYGSHk7tPXikynS7ogEvDej/m4=" crossorigin="anonymous"></script> <script src="https://cdn.jsdelivr.net/npm/bootstrap@4.6.1/dist/js/bootstrap.bundle.min.js" integrity="sha256-fgLAgv7fyCGopR/gBNq2iW3ZKIdqIcyshnUULC4vex8=" crossorigin="anonymous"></script> <script src="https://cdn.jsdelivr.net/npm/mdbootstrap@4.20.0/js/mdb.min.js" integrity="sha256-NdbiivsvWt7VYCt6hYNT3h/th9vSTL4EDWeGs5SN3DA=" crossorigin="anonymous"></script> <script defer src="https://cdn.jsdelivr.net/npm/masonry-layout@4.2.2/dist/masonry.pkgd.min.js" integrity="sha256-Nn1q/fx0H7SNLZMQ5Hw5JLaTRZp0yILA/FRexe19VdI=" crossorigin="anonymous"></script> <script defer src="https://cdn.jsdelivr.net/npm/imagesloaded@4/imagesloaded.pkgd.min.js"></script> <script defer src="/assets/js/masonry.js" type="text/javascript"></script> <script defer src="https://cdn.jsdelivr.net/npm/medium-zoom@1.0.6/dist/medium-zoom.min.js" integrity="sha256-EdPgYcPk/IIrw7FYeuJQexva49pVRZNmt3LculEr7zM=" crossorigin="anonymous"></script> <script defer src="/assets/js/zoom.js"></script> <script defer src="/assets/js/common.js"></script> <script type="text/javascript">window.MathJax={tex:{tags:"ams"}};</script> <script defer type="text/javascript" id="MathJax-script" src="https://cdn.jsdelivr.net/npm/mathjax@3.2.0/es5/tex-mml-chtml.js"></script> <script defer src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script> </body> </html>